<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panelto Bakery</title>
<style>
  :root{--bg:#f6f8fb;--ink:#0f172a;--muted:#64748b;--card:#ffffff;--brand:#0b63d6}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #eef2f7}
  .hwrap{max-width:960px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .title{font-weight:800}
  main{max-width:960px;margin:0 auto;padding:12px}

  /* L1 & L2: full-width stacked rectangles (mobile-first) */
  .stack{display:flex;flex-direction:column;gap:10px}
  .tile{display:block;background:linear-gradient(135deg,#ffffff,#f4f7fc);border:1px solid #e6edf7;border-radius:14px;box-shadow:0 10px 28px rgba(12,26,75,.06);padding:18px 16px;text-decoration:none;color:inherit}
  .tile h2{margin:0 0 4px 0;font-size:1.1rem}
  .tile p{margin:0;color:var(--muted);font-size:.9rem}
  .tile:active{transform:translateY(1px)}

  /* L3: categories grid 2x2 */
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .square{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
  .c1{background:linear-gradient(135deg,#fff7ed,#ffe6c8)}
  .c2{background:linear-gradient(135deg,#eff6ff,#cfe2ff)}
  .c3{background:linear-gradient(135deg,#ecfdf5,#cdf9da)}
  .c4{background:linear-gradient(135deg,#f3e8ff,#dfccff)}

  .card{background:var(--card);border:1px solid #e6edf7;border-radius:14px;box-shadow:0 10px 28px rgba(12,26,75,.06);padding:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px}
  .crumbs a{color:var(--brand);text-decoration:none}
  .crumbs .sep{opacity:.45}

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{padding:8px 10px;border-radius:10px;border:1px solid #e6edf7}
  .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;color:#0f172a;border:1px solid #e6edf7}
  .small{font-size:.86rem;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid #eef2f7;border-radius:10px;padding:8px}

  footer{height:1px} /* empty as requested */
</style>
</head>
<body>
  <header><div class="hwrap"><div class="title">Panelto Bakery</div></div></header>
  <main>
    <nav class="crumbs" id="crumbs"></nav>
    <section id="view">
      <!-- Fallback static home -->
      <div class="stack">
        <a class="tile" href="?bakery=Bakery 1"><h2>Bakery 1</h2><p>Open</p></a>
        <a class="tile" href="?bakery=Bakery 2"><h2>Bakery 2</h2><p>Open</p></a>
        <a class="tile" href="?bakery=Bakery 3"><h2>Bakery 3</h2><p>Open</p></a>
      </div>
    </section>
  </main>
  <footer></footer>

  <!-- Google Identity Services + Google API client -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

<script>
/******** QUICK SETUP ********
1) Upiši svoje podatke dolje (CLIENT_ID, API_KEY)
2) Popuni FOLDERS (Bakery → Machine → Category)
   Category ključevi: 'documentation', 'works', 'electrical', 'procedures'
******************************/
const CLIENT_ID = '937032004801-nfma3pp3fkkck4mfk094imqgmvduj7ih.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyDnEsld28xzG1lQROwBO_ImDq2SxX4kcg8';
const SCOPES    = 'https://www.googleapis.com/auth/drive.file'; // ili '.../drive' za siru listu

const MACHINES = {
  'Bakery 1': ['Mixing','Fermentation','Fritsch','Proover','Oven','Cooler','Freezer','Retarder'],
  'Bakery 2': ['Mixing','Fermentation','Rademaker','Proover','Scarifier','Oven','Cooler','Freezer'],
  'Bakery 3': [] // prazno = odmah 4 kvadrata (koristi placeholder '—' u FOLDERS ako želiš)
};

// Mapiranje Drive foldera (unesi svoje ID-eve)
const FOLDERS = {
  'Bakery 1': {
    'Fritsch': {
      documentation: '1uKMNjOdQltXZDMOrjs8nCDdQNdU0Dupw', // npr. 1AbC...
      works:         '1M0NE6MtE0i-RNcckiFT8KCoMMwYdOdG_',
      electrical:    '1RCWfvgcjDVCbutedlh3lyWjJ_kW5As9L',
      procedures:    '1ismVYGrYFzwSbzxcoY_xki_KLhkdPpz0',  // npr. 1ismVYGrYF...
    }
  }    // dodaj ostale strojeve...
  },
  'Bakery 2': {
    // strojevi...
  },
  'Bakery 3': {
    // ako želiš odmah 4 kvadrata bez strojeva:
    // '—': { documentation:'', works:'', electrical:'', procedures:'' }
  }
};

const CATS = {
  documentation: { title:'Documentation',       color:'c1', desc:'User manuals & technical docs' },
  works:         { title:'Work History',        color:'c2', desc:'Repairs, interventions' },
  electrical:    { title:'Electrical Diagrams', color:'c3', desc:'Wiring & schematics' },
  procedures:    { title:'Procedures',          color:'c4', desc:'SOPs & guides' }
};

// Router
function params(){ return new URLSearchParams(location.search); }
function go(obj){ const u=new URL(location.href); u.search=new URLSearchParams(obj).toString(); history.pushState({},'',u); draw(); }
window.addEventListener('popstate', draw);

function crumbsSet(items){
  const el = document.getElementById('crumbs'); el.innerHTML='';
  items.forEach((it,i)=>{
    const a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=it.label;
    a.onclick=()=>{ go(it.to||{}); };
    el.appendChild(a); if(i<items.length-1){ const s=document.createElement('span'); s.className='sep'; s.textContent='›'; el.appendChild(s); }
  });
}

function drawHome(){
  crumbsSet([{label:'Home'}]);
  const view=document.getElementById('view');
  view.innerHTML='';
  const wrap=document.createElement('div'); wrap.className='stack';
  ['Bakery 1','Bakery 2','Bakery 3'].forEach(b=>{
    const a=document.createElement('a'); a.className='tile'; a.href=`?bakery=${encodeURIComponent(b)}`;
    a.innerHTML=`<h2>${b}</h2><p>Open</p>`; wrap.appendChild(a);
  });
  view.appendChild(wrap);
}

function drawBakery(b){
  crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}}]);
  const view=document.getElementById('view'); view.innerHTML='';
  const machines = MACHINES[b]||[];
  if(!machines.length){ drawMachine(b,'—'); return; } // Bakery 3 → odmah 4 kvadrata
  const wrap=document.createElement('div'); wrap.className='stack';
  machines.forEach(m=>{
    const a=document.createElement('a'); a.className='tile'; a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}`;
    a.innerHTML=`<h2>${m}</h2><p>Open</p>`; wrap.appendChild(a);
  });
  view.appendChild(wrap);
}

function drawMachine(b,m){
  crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}}]);
  const view=document.getElementById('view'); view.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const h=document.createElement('h3'); h.textContent=`${b} › ${m}`; card.appendChild(h);
  const grid=document.createElement('div'); grid.className='grid';
  Object.entries(CATS).forEach(([k,meta])=>{
    const a=document.createElement('a'); a.className=`tile square ${meta.color}`; a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
    a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`; grid.appendChild(a);
  });
  card.appendChild(grid); document.getElementById('view').appendChild(card);
}

// ===== Google Drive integration =====
let accessToken=null, gapiReady=false;
async function ensureGapi(){ if(gapiReady) return; await new Promise(r=>gapi.load('client',r)); await gapi.client.init({apiKey:API_KEY, discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']}); gapiReady=true; }
async function ensureAuth(){ if(accessToken) return accessToken; await ensureGapi(); return new Promise((res,rej)=>{ const c=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:r=>{ if(r&&r.access_token){accessToken=r.access_token;res(accessToken);} else rej(new Error('No token')); }}); c.requestAccessToken({prompt:'consent'}); }); }

function folderIdFor(b,m,cat){ return FOLDERS?.[b]?.[m]?.[cat] || null; }

function drawCategory(b,m,catKey){
  const cat=CATS[catKey]; if(!cat){ go({bakery:b,machine:m}); return; }
  crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}},{label:cat.title,to:{bakery:b,machine:m,cat:catKey}}]);
  const view=document.getElementById('view'); view.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const h=document.createElement('h3'); h.textContent=`${b} › ${m} › ${cat.title}`; card.appendChild(h);

  const fid = folderIdFor(b,m,catKey);
  const hint=document.createElement('div'); hint.className='small';
  hint.innerHTML = fid ? `Folder ID: <code>${escapeHtml(fid)}</code>` : `⚠️ Set Drive folder ID in <code>FOLDERS</code>.`;
  card.appendChild(hint);

  const bar=document.createElement('div'); bar.className='toolbar';
  const search=document.createElement('input'); search.type='search'; search.placeholder='Search files';
  const file=document.createElement('input'); file.type='file'; file.accept='application/pdf,image/*';
  const up=document.createElement('button'); up.className='btn'; up.textContent='Upload';
  const refresh=document.createElement('button'); refresh.className='btn ghost'; refresh.textContent='Refresh';

  const openPublic = document.createElement('a');
  openPublic.className = 'btn';
  openPublic.textContent = 'Open folder (no login)';
  openPublic.href = fid ? `https://drive.google.com/drive/folders/${fid}` : '#';
  openPublic.target = '_blank';
  openPublic.rel = 'noopener';

  const adminBtn = document.createElement('button');
  adminBtn.className = 'btn ghost';
  adminBtn.textContent = 'Admin: Sign in';

  bar.prepend(openPublic, adminBtn);
  bar.append(search,file,up,refresh); 
  card.appendChild(bar);

  const list=document.createElement('div'); list.className='list'; card.appendChild(list);
  view.appendChild(card);

  // default: PUBLIC listing visible (no login). Admin controls hidden.
  file.style.display = 'none';
  up.style.display = 'none';
  // refresh/search initially use PUBLIC mode
  list.style.display = '';
  search.style.display = '';

  // PUBLIC list (no login) — works only if folder/files are "Anyone with link → Viewer"
  async function publicListFiles(){
    list.innerHTML = '<div class="small">Loading…</div>';
    try{
      if(!fid){ list.innerHTML = '<div class="small">Set Drive folder ID.</div>'; return; }
      const params = new URLSearchParams({
        q: `('${fid}' in parents) and trashed=false`,
        fields: 'files(id,name,modifiedTime,mimeType,webViewLink)',
        orderBy: 'modifiedTime desc',
        pageSize: '100',
        key: API_KEY
      });
      const res = await fetch('https://www.googleapis.com/drive/v3/files?' + params.toString());
      if(!res.ok){
        const j = await res.json().catch(()=>({}));
        throw new Error(j.error?.message || ('HTTP '+res.status));
      }
      const data = await res.json();
      let items = data.files || [];
      const s = (search.value||'').toLowerCase();
      if(s) items = items.filter(f => (f.name||'').toLowerCase().includes(s));
      if(!items.length){ list.innerHTML = '<div class="small">No files yet.</div>'; return; }
      list.innerHTML = '';
      items.forEach(f=>{
        const row = document.createElement('div'); row.className='item';
        const when = f.modifiedTime ? new Date(f.modifiedTime).toLocaleString() : '';
        row.innerHTML = `<div><strong>${escapeHtml(f.name)}</strong><div class='small'>${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
        const v = document.createElement('a'); v.className='btn ghost'; v.textContent='View';
        v.href = f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`;
        v.target='_blank'; v.rel='noopener';
        const dl = document.createElement('a'); dl.className='btn'; dl.textContent='Download';
        dl.href = `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;
        dl.target='_blank'; dl.rel='noopener';
        actions.append(v,dl);
        row.appendChild(actions);
        list.appendChild(row);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="small">Public list error: ${escapeHtml(e.message||String(e))}.
        <br/>If you see 403/401, set folder/files to “Anyone with the link → Viewer”, or use Admin Sign-in.</div>`;
    }
  }

  // PRIVATE list (requires admin sign-in)
  async function privateListFiles(){
    list.innerHTML='<div class="small">Loading…</div>';
    try{
      if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
      const q = `('${fid}' in parents) and trashed=false`;
      const res = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink)', orderBy:'modifiedTime desc', pageSize:100 });
      let items=res.result.files||[];
      const s=(search.value||'').toLowerCase();
      if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
      if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
      list.innerHTML='';
      items.forEach(f=>{
        const row=document.createElement('div'); row.className='item';
        const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
        row.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class='small'>${escapeHtml(f.mimeType)} • ${escapeHtml(when)}</div></div>`;
        const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
        const v=document.createElement('a'); v.className='btn ghost'; v.textContent='View'; v.href=f.webViewLink||`https://drive.google.com/file/d/${f.id}/view`; v.target='_blank'; v.rel='noopener';
        const dl=document.createElement('a'); dl.className='btn'; dl.textContent='Download'; dl.href=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`; dl.target='_blank'; dl.rel='noopener';
        const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick=async()=>{ if(!confirm('Delete file?')) return; try{ await gapi.client.drive.files.delete({fileId:f.id}); privateListFiles(); }catch(e){ alert('Delete failed: '+(e.result?.error?.message||e.message)); } };
        actions.append(v,dl,del); row.appendChild(actions); list.appendChild(row);
      });
    }catch(e){ console.error(e); list.innerHTML=`<div class='small'>Error: ${escapeHtml(e.message||String(e))}</div>`; }
  }

  // initial: public listing
  publicListFiles();
  refresh.onclick = publicListFiles;
  search.oninput = publicListFiles;

  // Admin login → show management UI and switch to private listing
  adminBtn.onclick = async () => {
    try{
      await ensureAuth();
      file.style.display = '';
      up .style.display  = '';
      // switch refresh/search to private mode
      refresh.onclick = privateListFiles;
      search .oninput = privateListFiles;
      adminBtn.style.display = 'none';
      await privateListFiles();
    }catch(e){
      alert('Sign-in failed: ' + (e.message || String(e)));
    }
  };

  // Upload with auto-public permission
  up.onclick=async()=>{
    try{
      if(!fid){ alert('Set Drive folder ID in FOLDERS.'); return; }
      if(!file.files || !file.files[0]){ alert('Choose a file'); return; }
      await ensureAuth(); up.disabled=true; up.textContent='Uploading…';
      const newId = await uploadToDrive(fid, file.files[0]);
      // Make uploaded file publicly readable
      await gapi.client.drive.permissions.create({
        fileId: newId,
        resource: { type: 'anyone', role: 'reader' }
      });
      file.value='';
      await privateListFiles(); // show it immediately in admin view
    }catch(e){ alert('Upload failed: '+(e.message||String(e))); }
    finally{ up.disabled=false; up.textContent='Upload'; }
  };
}

async function uploadToDrive(folderId, file){
  const boundary='-------314159265358979323846';
  const delimiter=`\r\n--${boundary}\r\n`;
  const closeDelim=`\r\n--${boundary}--`;
  const meta={ name:file.name, parents:[folderId] };
  const ab=await file.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(ab)));
  const body=delimiter+'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(meta)+
             delimiter+'Content-Type: '+(file.type||'application/octet-stream')+'\r\nContent-Transfer-Encoding: base64\r\n\r\n'+b64+closeDelim;
  const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink',{method:'POST',headers:{'Authorization':'Bearer '+accessToken,'Content-Type':'multipart/related; boundary='+boundary},body});
  if(!r.ok){ const j=await r.json().catch(()=>({})); throw new Error(j.error?.message||'Upload failed'); }
  const created = await r.json();
  return created.id; // return file id so we can set permission
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function draw(){
  const p=params(); const b=p.get('bakery'); const m=p.get('machine'); const c=p.get('cat');
  if(!b){ drawHome(); return; }
  if(b && !m){ drawBakery(b); return; }
  if(b && m && !c){ drawMachine(b,m); return; }
  if(b && m && c){ drawCategory(b,m,c); return; }
}

window.addEventListener('load', draw);

// Debug: show JS errors in UI
window.addEventListener('error', (e)=>{
  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`<div class='small'>JavaScript error: ${escapeHtml(e.message||'unknown')}</div>`;
  document.getElementById('view')?.appendChild(el);
});
</script>
</body>
</html>
